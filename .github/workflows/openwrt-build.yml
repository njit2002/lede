name: Build OpenWRT for New3 (MT7621)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Clean disk space & fix dependencies
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          docker rmi $(docker images -q) 2>/dev/null
          sudo apt-get update && sudo apt-get install -y libtool automake autoconf bison flex
          df -h

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          submodules: true

      - name: Update feeds & clean cache
        run: |
          ./scripts/feeds clean
          ./scripts/feeds update -a -f
          ./scripts/feeds install -a -f
          rm -rf feeds/packages/devel/pcre2/{build_dir,stamp}
          rm -rf dl/pcre2-*

      - name: Copy custom config (核心修复：强制加载new3的.config)
        run: |
          # 确保仓库根目录有正确的.config文件
          if [ -f .config ]; then
            cp .config .config.bak
            # 强制生成new3基础配置，覆盖默认x86配置
            echo "CONFIG_TARGET_ramips=y" > .config
            echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
            echo "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" >> .config
            # 追加精简版的核心功能配置
            cat >> .config << EOF
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_wpad-basic-mbedtls=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_kmod-wireguard=y
CONFIG_PACKAGE_wireguard-tools=y
CONFIG_PACKAGE_luci-app-wireguard=y
CONFIG_PACKAGE_luci-i18n-wireguard-zh-cn=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_usb-modeswitch=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
CONFIG_PACKAGE_uqmi=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_usbutils=y
# 禁用冲突组件
CONFIG_PACKAGE_linux-atm=n
CONFIG_PACKAGE_kmod-atm=n
EOF
            make defconfig
          else
            echo "Error: .config file not found!"
            exit 1
          fi

      - name: Verify target architecture (验证配置是否正确)
        run: |
          # 检查.config中是否包含new3的架构配置
          grep -E "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2" .config
          if [ $? -ne 0 ]; then
            echo "Error: New3 target not found in .config!"
            exit 1
          fi

      - name: Add swap space
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Download packages
        run: make download -j8

      - name: Compile firmware
        run: make -j$(nproc) || make -j1 V=s

      - name: Check firmware files
        run: |
          # 列出ramips/mt7621目录下的文件（验证是否生成）
          ls -l bin/targets/ramips/mt7621/
          # 列出所有固件目录，确认架构
          ls -l bin/targets/

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-new3-firmware
          path: bin/targets/ramips/mt7621/
          if-no-files-found: error  # 若仍为空，直接报错提示
