name: Build OpenWRT for New3 (MT7621)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # æ­¥éª¤1ï¼šæ¸…ç†ç£ç›˜+å®‰è£…ä¾èµ–
      - name: Clean disk & install dependencies
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          docker rmi $(docker images -q) 2>/dev/null
          sudo apt-get update && sudo apt-get install -y libtool automake autoconf bison flex
          df -h

      # æ­¥éª¤2ï¼šæ‹‰å–æºç 
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          submodules: true

      # æ­¥éª¤3ï¼šæ›´æ–°feeds+æ¸…ç†ç¼“å­˜
      - name: Update feeds & clean cache
        run: |
          ./scripts/feeds clean
          ./scripts/feeds update -a -f
          ./scripts/feeds install -a -f
          rm -rf feeds/packages/devel/pcre2/{build_dir,stamp}
          rm -rf dl/pcre2-*

      # æ­¥éª¤4ï¼šç”ŸæˆNew3é…ç½®ï¼ˆæ ¸å¿ƒï¼šç”¨echoé€è¡Œè¿½åŠ ï¼Œæ— EOFï¼‰
      - name: Generate New3 config file
        run: |
          # 1. åŸºç¡€æ¶æ„é…ç½®ï¼ˆå¼ºåˆ¶æŒ‡å®šnew3ï¼Œè¦†ç›–x86é»˜è®¤ï¼‰
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" >> .config
          
          # 2. ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶
          echo "CONFIG_PACKAGE_base-files=y" >> .config
          echo "CONFIG_PACKAGE_busybox=y" >> .config
          echo "CONFIG_PACKAGE_dropbear=y" >> .config
          echo "CONFIG_PACKAGE_firewall=y" >> .config
          echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
          echo "CONFIG_PACKAGE_opkg=y" >> .config
          echo "CONFIG_PACKAGE_wpad-basic-mbedtls=y" >> .config
          
          # 3. LuCIä¸­æ–‡ç•Œé¢
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          
          # 4. WireGuardç»„ä»¶
          echo "CONFIG_PACKAGE_kmod-wireguard=y" >> .config
          echo "CONFIG_PACKAGE_wireguard-tools=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-wireguard=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-wireguard-zh-cn=y" >> .config
          
          # 5. USBéšèº«WiFié©±åŠ¨
          echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
          echo "CONFIG_PACKAGE_usb-modeswitch=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-net=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-net-rtl8152=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y" >> .config
          
          # 6. 4Gæ‹¨å·å·¥å…·
          echo "CONFIG_PACKAGE_uqmi=y" >> .config
          echo "CONFIG_PACKAGE_ppp=y" >> .config
          echo "CONFIG_PACKAGE_ppp-mod-pppoe=y" >> .config
          
          # 7. è°ƒè¯•å·¥å…·+ç¦ç”¨å†²çªç»„ä»¶
          echo "CONFIG_PACKAGE_usbutils=y" >> .config
          echo "CONFIG_PACKAGE_linux-atm=n" >> .config
          echo "CONFIG_PACKAGE_kmod-atm=n" >> .config
          
          # 8. è‡ªåŠ¨è¡¥å…¨ä¾èµ–
          make defconfig

      # æ­¥éª¤5ï¼šéªŒè¯æ¶æ„é…ç½®
      - name: Verify architecture config
        run: |
          if ! grep -q "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" .config; then
            echo "Error: New3 architecture config missing!"
            exit 1
          fi
          echo "âœ… New3 config verified successfully"

      # æ­¥éª¤6ï¼šæ·»åŠ 4Gäº¤æ¢åˆ†åŒºï¼ˆç¼“è§£å†…å­˜ä¸è¶³ï¼‰
      - name: Add swap space
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          swapon --show

      # æ­¥éª¤7ï¼šä¸‹è½½ä¾èµ–åŒ…
      - name: Download packages
        run: make download -j8

      # æ­¥éª¤8ï¼šç¼–è¯‘å›ºä»¶
      - name: Compile firmware
        run: make -j$(nproc) || make -j1 V=s

      # æ­¥éª¤9ï¼šæ£€æŸ¥å›ºä»¶ç”Ÿæˆ
      - name: Check firmware files
        run: |
          echo "ğŸ“ Firmware files list:"
          ls -l bin/targets/ramips/mt7621/ || echo "No firmware files found"
          ls -l bin/targets/

      # æ­¥éª¤10ï¼šä¸Šä¼ å›ºä»¶
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-new3-firmware
          path: bin/targets/ramips/mt7621/
          if-no-files-found: error
