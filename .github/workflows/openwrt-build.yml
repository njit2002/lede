name: Build OpenWRT for New3 (MT7621)

# ä»…æ‰‹åŠ¨è§¦å‘ç¼–è¯‘
on:
  workflow_dispatch:

jobs:
  build:
    # æŒ‡å®šç¼–è¯‘çŽ¯å¢ƒä¸ºUbuntu 22.04
    runs-on: ubuntu-22.04
    steps:
      # æ­¥éª¤1ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ + å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆæ ¸å¿ƒï¼‰
      - name: Clean disk space & fix dependencies
        run: |
          # æ¸…ç†å¤§ä½“ç§¯æ— ç”¨ç»„ä»¶ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          docker rmi $(docker images -q) 2>/dev/null
          # å®‰è£…ç¼–è¯‘å¿…éœ€ä¾èµ–ï¼Œä¿®å¤linux-atm/pcre2ç¼–è¯‘çŽ¯å¢ƒ
          sudo apt-get update && sudo apt-get install -y libtool automake autoconf bison flex
          # æŸ¥çœ‹æ¸…ç†åŽç£ç›˜ç©ºé—´
          df -h

      # æ­¥éª¤2ï¼šæ‹‰å–Leançš„ledeæºç 
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          submodules: true

      # æ­¥éª¤3ï¼šæ›´æ–°feeds + æ¸…ç†pcre2ç¼“å­˜ï¼ˆä¿®å¤ç¼–è¯‘å¤±è´¥ï¼‰
      - name: Update feeds & clean cache
        run: |
          ./scripts/feeds clean
          ./scripts/feeds update -a -f
          ./scripts/feeds install -a -f
          # å¼ºåˆ¶æ¸…ç†pcre2çš„ç¼–è¯‘ç¼“å­˜å’Œä¸‹è½½æ–‡ä»¶ï¼Œé¿å…ç‰ˆæœ¬å†²çª
          rm -rf feeds/packages/devel/pcre2/{build_dir,stamp}
          rm -rf dl/pcre2-*

      # æ­¥éª¤4ï¼šå¼ºåˆ¶ç”ŸæˆNew3çš„.configé…ç½®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šYAMLè¯­æ³•+æž¶æž„é…ç½®ï¼‰
      - name: Copy custom config (Force load New3 config)
        run: |
          # å¤‡ä»½æ—§é…ç½®ï¼ˆè‹¥æœ‰ï¼‰
          if [ -f .config ]; then
            cp .config .config.bak
          fi
          # å¼ºåˆ¶ç”ŸæˆNew3ï¼ˆramips/mt7621ï¼‰åŸºç¡€æž¶æž„é…ç½®ï¼Œè¦†ç›–é»˜è®¤x86
          echo "CONFIG_TARGET_ramips=y" > .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" >> .config
          # è¿½åŠ æ ¸å¿ƒåŠŸèƒ½é…ç½®ï¼ˆWireGuard + USBéšèº«WiFi + ä¸­æ–‡LuCIï¼‰
          cat >> .config << EOF
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_wpad-basic-mbedtls=y
# LuCIä¸­æ–‡ç•Œé¢
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
# WireGuardå…¨å¥—ç»„ä»¶
CONFIG_PACKAGE_kmod-wireguard=y
CONFIG_PACKAGE_wireguard-tools=y
CONFIG_PACKAGE_luci-app-wireguard=y
CONFIG_PACKAGE_luci-i18n-wireguard-zh-cn=y
# USBéšèº«WiFiæ ¸å¿ƒé©±åŠ¨
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_usb-modeswitch=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
# 4Gæ‹¨å·æ ¸å¿ƒå·¥å…·
CONFIG_PACKAGE_uqmi=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
# è°ƒè¯•å·¥å…·
CONFIG_PACKAGE_usbutils=y
# ç¦ç”¨å†²çªç»„ä»¶ï¼ˆä¿®å¤linux-atmç¼–è¯‘å¤±è´¥ï¼‰
CONFIG_PACKAGE_linux-atm=n
CONFIG_PACKAGE_kmod-atm=n
EOF
          # è‡ªåŠ¨è¡¥å…¨é…ç½®ä¾èµ–
          make defconfig

      # æ­¥éª¤5ï¼šéªŒè¯æž¶æž„é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆé˜²æ­¢ç¼–è¯‘é”™æž¶æž„ï¼‰
      - name: Verify target architecture
        run: |
          # æ£€æŸ¥.configä¸­æ˜¯å¦åŒ…å«New3çš„æž¶æž„é…ç½®
          if ! grep -E "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" .config; then
            echo "Error: New3 target config not found!"
            exit 1
          fi
          echo "âœ… New3 architecture config verified successfully!"

      # æ­¥éª¤6ï¼šæ·»åŠ 4Gäº¤æ¢åˆ†åŒºï¼ˆç¼“è§£å†…å­˜ä¸è¶³ï¼‰
      - name: Add swap space
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          # éªŒè¯swapæ˜¯å¦ç”Ÿæ•ˆ
          swapon --show

      # æ­¥éª¤7ï¼šä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
      - name: Download packages
        run: make download -j8

      # æ­¥éª¤8ï¼šç¼–è¯‘å›ºä»¶ï¼ˆå¤šçº¿ç¨‹ä¼˜å…ˆï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹è¾“å‡ºæ—¥å¿—ï¼‰
      - name: Compile firmware
        run: make -j$(nproc) || make -j1 V=s

      # æ­¥éª¤9ï¼šéªŒè¯å›ºä»¶æ˜¯å¦ç”Ÿæˆï¼ˆå…³é”®ï¼‰
      - name: Check firmware files
        run: |
          # åˆ—å‡ºramips/mt7621ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆç¡®è®¤New3å›ºä»¶ç”Ÿæˆï¼‰
          echo "ðŸ“ Firmware files in ramips/mt7621:"
          ls -l bin/targets/ramips/mt7621/
          # åˆ—å‡ºæ‰€æœ‰å›ºä»¶ç›®å½•ï¼Œç¡®è®¤æž¶æž„
          echo -e "\nðŸ“ All target directories:"
          ls -l bin/targets/

      # æ­¥éª¤10ï¼šä¸Šä¼ å›ºä»¶ï¼ˆä»…å½“æ–‡ä»¶å­˜åœ¨æ—¶ï¼‰
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-new3-firmware
          path: bin/targets/ramips/mt7621/
          if-no-files-found: error  # å›ºä»¶ä¸ºç©ºæ—¶ç›´æŽ¥æŠ¥é”™ï¼Œä¾¿äºŽæŽ’æŸ¥
