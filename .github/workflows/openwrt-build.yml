name: Build OpenWRT for New3 (MT7621)

on:
  workflow_dispatch:  # 仅手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04  # 云端编译环境
    steps:
      - name: Clean disk space & fix dependencies (核心修复步骤)
        run: |
          # 清理大体积无用组件，释放磁盘空间
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          docker rmi $(docker images -q) 2>/dev/null
          # 安装编译必需依赖，修复linux-atm/pcre2编译环境
          sudo apt-get update && sudo apt-get install -y libtool automake autoconf bison flex
          # 查看清理后磁盘空间
          df -h

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          submodules: true

      - name: Update feeds & clean pcre2 cache (核心修复步骤)
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 强制清理pcre2的编译缓存和下载文件，避免版本冲突
          rm -rf feeds/packages/devel/pcre2/{build_dir,stamp}
          rm -rf dl/pcre2-*

      - name: Load custom configuration
        run: |
          # 检查并加载.config，自动补全依赖（已移除冗余cp命令）
          make defconfig

      - name: Download packages
        run: make download -j8

      - name: Compile firmware (单线程日志优先，成功后可改回多线程)
        run: make -j1 V=s  # 单线程编译，输出完整日志，便于排查残留问题
        # 若编译成功，后续可替换为多线程编译：
        # run: make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-new3-firmware
          path: bin/targets/ramips/mt7621/  # 固件输出目录
